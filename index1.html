<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Drishti - Share Your Story</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        .modal-content-enter-active {
            transition: all 0.3s ease;
        }
        .modal-content-leave-active {
            transition: all 0.3s ease;
        }
        .modal-content-enter-from, .modal-content-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble-bot {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            border-bottom-left-radius: 0.25rem;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-white {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            animation: bounce 1.4s infinite both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0.0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex-shrink-0 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <span class="ml-2 text-2xl font-bold text-gray-800">Cyber Drishti</span>
                    </div>
                    <button @click="openModal" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        Share Your Story
                    </button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Community Stories</h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">Read anonymous experiences from our community. Learn how to stay safe from real-world threats.</p>
            </div>

            <!-- "Our Mission" Section -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 mb-12">
                <div class="flex flex-col md:flex-row items-center">
                    <div class="flex-shrink-0 mb-6 md:mb-0 md:mr-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">Our Mission: Safety in Sharing</h2>
                        <p class="text-gray-600 text-lg mb-4">Cyber Drishti is a safe space built on a simple idea: the best way to fight cyber threats is to learn from each other. We provide a 100% anonymous platform for you to share your experiences.</p>
                        <p class="text-gray-600 text-lg">By talking to our secure AI assistant, your story is transformed into an anonymous narrative. This narrative then helps educate others, raising awareness and preventing similar incidents from happening to someone else.</p>
                    </div>
                </div>
            </div>
            <!-- End of "Our Mission" Section -->


            <!-- Incidents Grid -->
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Latest Reports</h2>
            <div v-if="loadingIncidents" class="flex justify-center items-center h-64">
                <div class="loader"></div>
            </div>
            <div v-else-if="incidents.length === 0" class="text-center text-gray-500 py-16">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <h3 class="text-xl font-semibold">No stories yet</h3>
                <p class="text-gray-500">Be the first to share your experience and help others.</p>
            </div>
            <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="incident in incidents" :key="incident.id" @click="openReader(incident)" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-200 cursor-pointer flex flex-col justify-between">
                    <div>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mb-3">{{ incident.category }}</span>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">{{ incident.title }}</h2>
                        <p class="text-gray-600 line-clamp-4">{{ incident.story }}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <span v-if="incident.createdAt" class="text-sm text-gray-500">Posted: {{ new Date(incident.createdAt.seconds * 1000).toLocaleDateString() }}</span>
                        <span v-else class="text-sm text-gray-500">Posting...</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat/Post Modal -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 p-4" @click.self="closeModal">
                <transition name="modal-content">
                    <div v-show="!isClosingModal" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
                        
                        <!-- Chatbot View -->
                        <div v-if="!isConversationDone" class="flex flex-col h-[80vh]">
                            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                                <h3 class="text-xl font-semibold">Share Your Experience</h3>
                                <button @click="closeModal" class="text-gray-400 hover:text-gray-600">&times;</button>
                            </div>
                            <div class="flex-grow p-4 overflow-y-auto space-y-4" ref="chatbox">
                                <!-- Initial Bot Message -->
                                <div class="flex justify-start">
                                    <div class="chat-bubble-bot p-3 rounded-lg max-w-md">
                                        <p>Hello. I'm here to listen. I'm an AI assistant, and my purpose is to help you share your story about a cyber incident, completely anonymously. Your story can help others avoid the same situation. Can you start by telling me a little about what happened?</p>
                                    </div>
                                </div>
                                <!-- Chat Messages -->
                                <div v-for="(msg, index) in chatMessages" :key="index" :class="msg.isUser ? 'flex justify-end' : 'flex justify-start'">
                                    <div :class="msg.isUser ? 'chat-bubble-user' : 'chat-bubble-bot'" class="p-3 rounded-lg max-w-md shadow-sm">
                                        <p v-if="!msg.isTyping" v-html="msg.text.replace(/\n/g, '<br>')"></p>
                                        <div v-if="msg.isTyping" class="typing-indicator">
                                            <span></span><span></span><span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-gray-200 bg-gray-50">
                                <div v-if="!isGeneratingStory" class="flex items-center space-x-2">
                                    <textarea v-model="userInput" @keydown.enter.prevent="sendMessage" placeholder="Type your message..." rows="2" class="flex-1 p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    <button @click="sendMessage" :disabled="!userInput.trim()" class="bg-blue-600 text-white p-3 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                    </button>
                                </div>
                                <div v-if="isGeneratingStory" class="text-center py-4">
                                    <p class="text-gray-600">Please wait, I'm processing our conversation...</p>
                                </div>
                                <button @click="endConversation" :disabled="chatMessages.length === 0 || isGeneratingStory" class="mt-2 w-full text-sm text-blue-600 hover:text-blue-800 disabled:text-gray-400">
                                    End chat & Generate Story
                                </button>
                            </div>
                        </div>

                        <!-- Story Review View -->
                        <div v-if="isConversationDone" class="flex flex-col max-h-[80vh]">
                            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                                <h3 class="text-xl font-semibold">Review Your Story</h3>
                                <button @click="closeModal" class="text-gray-400 hover:text-gray-600">&times;</button>
                            </div>
                            <div class="flex-grow p-6 overflow-y-auto">
                                <div v-if="isGeneratingStory" class="flex flex-col items-center justify-center h-64">
                                    <div class="loader mb-4"></div>
                                    <p class="text-gray-600 text-lg">Drafting your story...</p>
                                    <p class="text-gray-500">This might take a moment.</p>
                                </div>
                                <div v-else-if="generatedStory">
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mb-3">{{ generatedStory.category }}</span>
                                    <h2 class="text-3xl font-bold mb-4">{{ generatedStory.title }}</h2>
                                    <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">{{ generatedStory.story }}</p>
                                </div>
                            </div>
                            <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                                <button @click="retryGeneration" v-if="!isPosting && !generatedStory && !isGeneratingStory" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-5 rounded-lg shadow-md transition duration-150 ease-in-out">
                                    Retry Generation
                                </button>
                                <button @click="postStory" :disabled="isPosting || isGeneratingStory || !generatedStory" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-gray-400 flex items-center justify-center w-48">
                                    <span v-if="isPosting" class="loader-white"></span>
                                    <span v-else>Post Anonymously</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </transition>
            </div>
        </transition>

        <!-- Story Reader Modal -->
        <transition name="modal">
            <div v-if="selectedIncident" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 p-4" @click.self="closeReader">
                <transition name="modal-content">
                    <div v-show="!isClosingReader" class="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden">
                        <div class="flex-shrink-0 flex justify-between items-center p-5 border-b border-gray-200">
                            <h3 class="text-xl font-semibold">{{ selectedIncident.title }}</h3>
                            <button @click="closeReader" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                        </div>
                        <div class="flex-grow p-6 overflow-y-auto">
                             <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mb-4">{{ selectedIncident.category }}</span>
                            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">{{ selectedIncident.story }}</p>
                        </div>
                        <div class="flex-shrink-0 p-4 border-t border-gray-200 bg-gray-50 text-right">
                             <span v-if="selectedIncident.createdAt" class="text-sm text-gray-500">Posted on {{ new Date(selectedIncident.createdAt.seconds * 1000).toLocaleDateString() }}</span>
                             <span v-else class="text-sm text-gray-500">Posting...</span>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>

        <!-- Success Message -->
        <div v-if="showSuccessMessage" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center space-x-3 z-50">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            <span>Story posted successfully! Thank you for helping others.</span>
        </div>

        <!-- Error Message -->
        <div v-if="showErrorMessage" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center space-x-3 z-50">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <span>Could not post the story. Please try again.</span>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { createApp, ref, reactive, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const showModal = ref(false);
                const isClosingModal = ref(false);
                const incidents = ref([]);
                const loadingIncidents = ref(true);
                const db = ref(null);
                const auth = ref(null);
                const selectedIncident = ref(null);
                const isClosingReader = ref(false);
                const showSuccessMessage = ref(false);
                const showErrorMessage = ref(false);

                // Chat State
                const chatMessages = reactive([]); // For display
                const chatHistory = reactive([]); // For API
                const userInput = ref('');
                const isBotTyping = ref(false);
                const isConversationDone = ref(false);
                const isGeneratingStory = ref(false);
                const isPosting = ref(false);
                const generatedStory = ref(null);
                const chatbox = ref(null);

                const openModal = () => {
                    resetChat();
                    showModal.value = true;
                    isClosingModal.value = false;
                };

                const closeModal = () => {
                    isClosingModal.value = true;
                    setTimeout(() => {
                        showModal.value = false;
                        isClosingModal.value = false;
                        resetChat();
                    }, 300);
                };

                const openReader = (incident) => {
                    selectedIncident.value = incident;
                    isClosingReader.value = false;
                };

                const closeReader = () => {
                    isClosingReader.value = true;
                    setTimeout(() => {
                        selectedIncident.value = null;
                        isClosingReader.value = false;
                    }, 300);
                };

                const scrollToBottom = () => {
                    nextTick(() => {
                        if (chatbox.value) {
                            chatbox.value.scrollTop = chatbox.value.scrollHeight;
                        }
                    });
                };

                const sendMessage = async () => {
                    const message = userInput.value.trim();
                    if (!message) return;

                    chatMessages.push({ text: message, isUser: true });
                    chatHistory.push({ role: "user", parts: [{ text: message }] });
                    userInput.value = '';
                    scrollToBottom();

                    chatMessages.push({ text: "...", isUser: false, isTyping: true });
                    isBotTyping.value = true;
                    scrollToBottom();

                    try {
                        const botResponse = await getGenerativeBotResponse();
                        chatMessages.pop(); // Remove typing indicator
                        chatMessages.push({ text: botResponse, isUser: false });
                        chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                    } catch (error) {
                        console.error("Error fetching bot response:", error);
                        chatMessages.pop(); // Remove typing indicator
                        chatMessages.push({ text: "I'm sorry, I'm having trouble connecting. Please try again.", isUser: false });
                    }
                    isBotTyping.value = false;
                    scrollToBottom();
                };

                const endConversation = () => {
                    isConversationDone.value = true;
                    isGeneratingStory.value = true;
                    generateStory();
                };

                const retryGeneration = () => {
                    isGeneratingStory.value = true;
                    generatedStory.value = null;
                    generateStory();
                };

                const getGenerativeBotResponse = async () => {
                    // ** 2. YOUR GEMINI API KEY FOR THE CHATBOT **
                    const apiKey = "AIzaSyDuiN8U2JhTKe6G0i4uGuKKWKw_i9qspzA";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                    const systemPrompt = `You are a patient, compassionate, and concise AI assistant for 'Cyber Drishti'. 
Your role is to gently guide a user, who is a victim of a cyber incident, to share their story.
Keep your responses and questions VERY SHORT and simple. The user is already frustrated.
Be empathetic, but get to the point.
Ask one question at a time.
Guide them to explain:
1. What happened? (The incident)
2. How did it start? (The trigger)
3. What was the impact? (Financial, emotional)
4. What did they learn? (The lesson)
When you feel you have enough information for these 4 points, end your message with the specific token: <|DONE|>`;

                    const payload = {
                        contents: chatHistory,
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        },
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    let text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure what to say.";

                    if (text.includes("<|DONE|>")) {
                        text = text.replace("<|DONE|>", "").trim();
                        isConversationDone.value = true;
                        generateStory();
                    }
                    
                    return text;
                };

                const generateStory = async () => {
                    // ** 3. YOUR GEMINI API KEY FOR STORY GENERATION **
                    const apiKey = "AIzaSyDuiN8U2JhTKe6G0i4uGuKKWKw_i9qspzA";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                    const conversationText = chatHistory
                        .filter(msg => msg.role === 'user' || msg.role === 'model')
                        .map(msg => `${msg.role === 'user' ? 'Victim' : 'Assistant'}: ${msg.parts[0].text}`)
                        .join('\n');

                    const systemPrompt = `You are a skilled storyteller. A user has just provided a conversation transcript detailing their experience as a victim of a cyberattack.
Your task is to turn this raw transcript into a compelling, anonymous, first-person story.
The story must be written in VERY SIMPLE, clear, and easy-to-read language. Make it engaging so people will want to read it.
The response must be a JSON object with this exact structure:
{
  "title": "A short, catchy title for the story",
  "category": "A single category (e.g., 'Phishing Scam', 'Identity Theft', 'Investment Fraud', 'Social Media Hack')",
  "story": "The full story, written from the victim's perspective ('I...', 'My...'). Make sure it's anonymous."
}
Do not include any other text or formatting. Just the JSON object.`;
                    
                    const userQuery = `Here is the conversation transcript:\n\n${conversationText}\n\nPlease generate the story from this.`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        },
                        generationConfig: {
                            responseMimeType: "application/json",
                        }
                    };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        const storyObject = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (storyObject) {
                            generatedStory.value = JSON.parse(storyObject);
                        } else {
                            throw new Error("Invalid story format received from API.");
                        }
                    } catch (error) {
                        console.error("Error generating story:", error);
                        generatedStory.value = null; // Allows retry
                    } finally {
                        isGeneratingStory.value = false;
                    }
                };


                const postStory = async () => {
                    if (!generatedStory.value || !db.value) return;
                    isPosting.value = true;
                    try {
                        const incidentsCollection = collection(db.value, `incidents`);
                        await addDoc(incidentsCollection, {
                            title: generatedStory.value.title,
                            category: generatedStory.value.category,
                            story: generatedStory.value.story,
                            createdAt: serverTimestamp()
                        });
                        
                        showSuccessMessage.value = true;
                        setTimeout(() => showSuccessMessage.value = false, 4000);
                        
                        closeModal();
                    } catch (error) {
                        console.error("Error posting story:", error);
                        showErrorMessage.value = true;
                        setTimeout(() => showErrorMessage.value = false, 4000);
                    } finally {
                        isPosting.value = false;
                    }
                };

                const resetChat = () => {
                    chatMessages.splice(0);
                    chatHistory.splice(0);
                    isConversationDone.value = false;
                    generatedStory.value = null;
                    userInput.value = '';
                    isGeneratingStory.value = false;
                    isPosting.value = false;
                    showErrorMessage.value = false;
                };

                // Firebase initialization
                onMounted(() => {
                    // ** 1. I'VE PASTED YOUR FIREBASE CONFIGURATION OBJECT HERE **
                    const firebaseConfig = {
                        apiKey: "AIzaSyAjUzD7ZWUST58HpN60Cn03k-sLwAA_HMA",
                        authDomain: "cyberdrishti-f96c7.firebaseapp.com",
                        projectId: "cyberdrishti-f96c7",
                        storageBucket: "cyberdrishti-f96c7.firebasestorage.app",
                        messagingSenderId: "35750026707",
                        appId: "1:35750026707:web:f1de1156b701eba8d92326",
                        measurementId: "G-SQL82N4DE2"
                    };

                    try {
                        const app = initializeApp(firebaseConfig);
                        db.value = getFirestore(app);
                        auth.value = getAuth(app);

                        onAuthStateChanged(auth.value, (user) => {
                            if (user) {
                                console.log("User signed in:", user.uid);
                                fetchIncidents();
                            } else {
                                // Simplified sign-in for local use
                                signInAnonymously(auth.value).catch(err => console.error("Anonymous sign in failed", err));
                            }
                        });
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        loadingIncidents.value = false;
                    }
                });

                const fetchIncidents = () => {
                    if (!db.value) return;
                    loadingIncidents.value = true;
                    const incidentsCollection = collection(db.value, `incidents`);
                    const q = query(incidentsCollection, orderBy('createdAt', 'desc'));

                    onSnapshot(q, (snapshot) => {
                        incidents.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loadingIncidents.value = false;
                    }, (error) => {
                        console.error("Error fetching incidents:", error);
                        loadingIncidents.value = false;
                    });
                };

                return {
                    showModal,
                    openModal,
                    closeModal,
                    isClosingModal,
                    incidents,
                    loadingIncidents,
                    chatMessages,
                    userInput,
                    sendMessage,
                    isBotTyping,
                    isConversationDone,
                    isGeneratingStory,
                    isPosting,
                    generatedStory,
                    postStory,
                    chatbox,
                    selectedIncident,
                    openReader,
                    closeReader,
                    isClosingReader,
                    showSuccessMessage,
                    showErrorMessage,
                    endConversation,
                    retryGeneration
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


